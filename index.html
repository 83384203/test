<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pexels 资源获取器 (单文件版)</title>
    <!-- 引入 Tailwind CSS (样式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <!-- 引入 Babel (让浏览器能看懂 React 代码) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 简单的滚动条美化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Search, Download, Key, ExternalLink, FileText, Trash2, Check, Video, Image as ImageIcon, AlertCircle, Copy, Terminal, Shuffle, Settings, Monitor, Layers, Loader2, X, AlertTriangle } from 'lucide-react';

        function App() {
            const [apiKey, setApiKey] = useState('');
            const [query, setQuery] = useState('');
            const [amount, setAmount] = useState(15);
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [showApiKeyInput, setShowApiKeyInput] = useState(true);
            const [mediaType, setMediaType] = useState('video');
            const [isRandom, setIsRandom] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [minQuality, setMinQuality] = useState('all');
            const [downloadQueue, setDownloadQueue] = useState({ isOpen: false, items: [], processing: false });
            const abortControllerRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('pexels_api_key');
                if (savedKey) {
                    setApiKey(savedKey);
                    setShowApiKeyInput(false);
                }
            }, []);

            useEffect(() => {
                setResults([]);
                setSelectedIds(new Set());
                setError('');
                setCurrentPage(1);
            }, [mediaType]);

            const saveApiKey = () => {
                if (apiKey.trim()) {
                    localStorage.setItem('pexels_api_key', apiKey);
                    setShowApiKeyInput(false);
                }
            };

            const clearApiKey = () => {
                localStorage.removeItem('pexels_api_key');
                setApiKey('');
                setShowApiKeyInput(true);
            };

            const getDownloadInfo = (item) => {
                if (mediaType === 'video') {
                    if (!item.video_files || item.video_files.length === 0) return null;
                    const sorted = [...item.video_files].sort((a, b) => b.width - a.width);
                    const best = sorted[0];
                    return { link: best.link, width: best.width, height: best.height, label: getResolutionLabel(best.width), ext: 'mp4' };
                } else {
                    return { link: item.src.original, width: item.width, height: item.height, label: getResolutionLabel(item.width), ext: 'jpg' };
                }
            };

            const getPreviewSource = (item) => {
                if (mediaType === 'video') {
                    if (!item.video_files) return null;
                    const sd = item.video_files.find(f => f.quality === 'sd');
                    if (sd) return sd.link;
                    const sorted = [...item.video_files].sort((a, b) => a.width - b.width);
                    return sorted[0]?.link;
                } else {
                    return item.src.large || item.src.medium;
                }
            };

            const getResolutionLabel = (width) => {
                if (width >= 3840) return '4K UHD';
                if (width >= 2560) return '2K QHD';
                if (width >= 1920) return 'Full HD';
                if (width >= 1280) return 'HD';
                return 'SD';
            };

            const meetsQuality = (item) => {
                if (minQuality === 'all') return true;
                let width = mediaType === 'video' ? (getDownloadInfo(item)?.width || 0) : item.width;
                switch (minQuality) {
                    case 'hd': return width >= 1280;
                    case 'fhd': return width >= 1920;
                    case '4k': return width >= 3840;
                    default: return true;
                }
            };

            const searchMedia = async () => {
                if (!apiKey) { setError('请输入 API Key 才能开始搜索'); setShowApiKeyInput(true); return; }
                if (!query) { setError('请输入搜索关键词'); return; }

                setLoading(true); setError(''); setResults([]); setSelectedIds(new Set());

                try {
                    let page = 1;
                    const fetchAmount = minQuality === 'all' ? amount : 80;
                    const baseUrl = mediaType === 'video' ? 'https://api.pexels.com/videos/search' : 'https://api.pexels.com/v1/search';

                    if (isRandom) {
                        const metaResponse = await fetch(`${baseUrl}?query=${query}&per_page=1`, { headers: { Authorization: apiKey } });
                        if (metaResponse.ok) {
                            const metaData = await metaResponse.json();
                            const totalResults = metaData.total_results;
                            if (totalResults > fetchAmount) {
                                const maxPage = Math.ceil(totalResults / fetchAmount);
                                const safeMaxPage = Math.min(maxPage, 50);
                                if (safeMaxPage > 1) page = Math.floor(Math.random() * safeMaxPage) + 1;
                            }
                        }
                    }
                    setCurrentPage(page);

                    const response = await fetch(`${baseUrl}?query=${query}&per_page=${fetchAmount}&page=${page}`, { headers: { Authorization: apiKey } });
                    if (!response.ok) throw new Error('网络请求失败，请检查 API Key');

                    const data = await response.json();
                    const items = mediaType === 'video' ? data.videos : data.photos;

                    let filteredItems = items;
                    if (minQuality !== 'all') {
                        filteredItems = items.filter(item => meetsQuality(item));
                    }
                    const finalItems = filteredItems.slice(0, amount);
                    
                    if (finalItems.length === 0) {
                        setError(`未找到相关资源`);
                    } else {
                        setResults(finalItems);
                        setSelectedIds(new Set(finalItems.map(v => v.id)));
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const toggleSelect = (id) => {
                const newSelected = new Set(selectedIds);
                if (newSelected.has(id)) newSelected.delete(id); else newSelected.add(id);
                setSelectedIds(newSelected);
            };

            const toggleSelectAll = () => {
                if (selectedIds.size === results.length) setSelectedIds(new Set()); else setSelectedIds(new Set(results.map(v => v.id)));
            };

            const exportTxt = () => {
                const urls = results.filter(item => selectedIds.has(item.id)).map(item => getDownloadInfo(item)?.link).filter(Boolean).join('\n');
                if (!urls) return alert('无内容');
                downloadBlob(urls, `pexels_links.txt`, 'text/plain');
            };

            const exportScript = (type) => {
                const selectedItems = results.filter(item => selectedIds.has(item.id));
                if (selectedItems.length === 0) return alert('请先选择');
                let content = type === 'windows' ? '@echo off\nif not exist "downloads" mkdir "downloads"\ncd downloads\n' : '#!/bin/bash\nmkdir -p downloads\ncd downloads\n';
                const filePrefix = mediaType === 'video' ? 'vid' : 'img';
                
                selectedItems.forEach(item => {
                    const info = getDownloadInfo(item);
                    if (info) {
                        const filename = `pexels_${filePrefix}_${item.id}.${info.ext}`;
                        content += type === 'windows' ? `curl -L "${info.link}" -o "${filename}"\n` : `curl -L "${info.link}" -o "${filename}"\n`;
                    }
                });
                if (type === 'windows') content += 'pause';
                downloadBlob(content, `download.${type === 'windows' ? 'bat' : 'sh'}`, 'text/plain');
            };

            const downloadBlob = (content, filename, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
            };

            const startBatchDownload = () => {
                const selectedItems = results.filter(item => selectedIds.has(item.id));
                if (selectedItems.length === 0) return alert('请先勾选');
                const queueItems = selectedItems.map(item => {
                    const info = getDownloadInfo(item);
                    return { id: item.id, link: info?.link, ext: info?.ext, name: `pexels_${mediaType}_${item.id}`, status: 'pending' };
                });
                setDownloadQueue({ isOpen: true, items: queueItems, processing: true });
                processQueue(queueItems);
            };

            const processQueue = async (initialItems) => {
                abortControllerRef.current = new AbortController();
                let currentItems = [...initialItems];
                for (let i = 0; i < currentItems.length; i++) {
                    if (abortControllerRef.current.signal.aborted) break;
                    currentItems = currentItems.map((item, index) => index === i ? { ...item, status: 'fetching' } : item);
                    setDownloadQueue(prev => ({ ...prev, items: currentItems }));
                    
                    try {
                        const item = currentItems[i];
                        const timeoutId = setTimeout(() => abortControllerRef.current.abort(), 60000);
                        const response = await fetch(item.link, { signal: abortControllerRef.current.signal });
                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error('Failed');

                        currentItems = currentItems.map((it, idx) => idx === i ? { ...it, status: 'saving' } : it);
                        setDownloadQueue(prev => ({ ...prev, items: currentItems }));

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `${item.name}.${item.ext}`;
                        document.body.appendChild(a); a.click();
                        setTimeout(() => { window.URL.revokeObjectURL(url); document.body.removeChild(a); }, 1000);
                        
                        currentItems = currentItems.map((it, idx) => idx === i ? { ...it, status: 'success' } : it);
                        setDownloadQueue(prev => ({ ...prev, items: currentItems }));
                        await new Promise(r => setTimeout(r, 800));
                    } catch (err) {
                         const isAborted = abortControllerRef.current.signal.aborted;
                         currentItems = currentItems.map((it, idx) => idx === i ? { ...it, status: 'error' } : it);
                         setDownloadQueue(prev => ({ ...prev, items: currentItems }));
                         if (isAborted) abortControllerRef.current = new AbortController();
                    }
                }
                setDownloadQueue(prev => ({ ...prev, processing: false }));
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans pb-20 relative">
                    <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 shadow-lg p-4">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-2">
                                <div className={`p-2 rounded-lg ${mediaType === 'video' ? 'bg-emerald-500' : 'bg-indigo-500'}`}>
                                    {mediaType === 'video' ? <Video className="w-6 h-6 text-white" /> : <ImageIcon className="w-6 h-6 text-white" />}
                                </div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-200 to-indigo-200">Pexels 资源获取器</h1>
                            </div>
                            <div className="flex flex-1 md:w-80 gap-2 w-full">
                                {showApiKeyInput ? (
                                    <>
                                    <input type="text" placeholder="粘贴 API Key" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-sm focus:border-indigo-500 outline-none" />
                                    <button onClick={saveApiKey} className="bg-indigo-600 px-4 py-2 rounded text-sm whitespace-nowrap">保存</button>
                                    </>
                                ) : (
                                    <div className="flex items-center gap-2 text-sm text-slate-400 bg-slate-900/50 px-3 py-1.5 rounded-full border border-slate-700">
                                        <Key className="w-4 h-4 text-emerald-500" /> <span>已连接</span>
                                        <button onClick={clearApiKey} className="text-slate-500 hover:text-red-400 ml-2"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700 mb-8">
                            <div className="flex justify-center mb-6">
                                <div className="bg-slate-900 p-1 rounded-xl flex gap-1 border border-slate-600">
                                    <button onClick={() => setMediaType('video')} className={`flex gap-2 px-6 py-2 rounded-lg transition-all ${mediaType === 'video' ? 'bg-emerald-600 text-white' : 'text-slate-400'}`}><Video className="w-4 h-4" /> 视频</button>
                                    <button onClick={() => setMediaType('photo')} className={`flex gap-2 px-6 py-2 rounded-lg transition-all ${mediaType === 'photo' ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}><ImageIcon className="w-4 h-4" /> 图片</button>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row gap-4 mb-4">
                                <div className="flex-1 relative">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" />
                                    <input type="text" placeholder={mediaType === 'video' ? "搜索视频..." : "搜索图片..."} value={query} onChange={(e) => setQuery(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && searchMedia()} className="w-full pl-10 pr-4 py-3 bg-slate-900 border border-slate-600 rounded-xl focus:border-indigo-500 outline-none text-lg" />
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-3 justify-between items-center">
                                <div className="flex gap-3 items-center flex-wrap">
                                    <input type="number" min="1" max="50" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-20 pl-2 pr-2 py-2.5 bg-slate-900 border border-slate-600 rounded-lg text-center" />
                                    <select value={minQuality} onChange={(e) => setMinQuality(e.target.value)} className="pl-2 pr-8 py-2.5 bg-slate-900 border border-slate-600 rounded-lg outline-none cursor-pointer text-sm">
                                        <option value="all">任意画质</option><option value="hd">HD+</option><option value="fhd">1080p+</option><option value="4k">4K</option>
                                    </select>
                                    <button onClick={() => setIsRandom(!isRandom)} className={`flex gap-2 px-4 py-2.5 rounded-lg border text-sm ${isRandom ? 'bg-purple-600/20 border-purple-500 text-purple-200' : 'bg-slate-900 border-slate-600 text-slate-400'}`}><Shuffle className="w-4 h-4" /> 随机</button>
                                </div>
                                <button onClick={searchMedia} disabled={loading} className={`px-8 py-2.5 rounded-lg font-bold shadow-lg transition-all active:scale-95 ${loading ? 'bg-slate-700 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-500'}`}>{loading ? '...' : '搜索'}</button>
                            </div>
                        </div>

                        {error && <div className="bg-amber-500/10 border border-amber-500/50 text-amber-200 p-4 rounded-xl mb-8 flex items-center gap-3"><AlertCircle className="w-5 h-5" />{error}</div>}

                        {results.length > 0 && (
                            <div className="flex flex-col xl:flex-row items-center justify-between mb-6 gap-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <div className="flex items-center gap-4"><button onClick={toggleSelectAll} className="flex gap-2 px-3 py-1.5 rounded-lg hover:bg-slate-700 border border-transparent hover:border-slate-500">{selectedIds.size === results.length ? <Check className="w-4 h-4 text-emerald-500"/> : <div className="w-4 h-4 border-2 border-slate-500 rounded-sm"></div>} 全选 ({selectedIds.size})</button><span className="text-slate-500 text-sm border-l border-slate-600 pl-4">第 <span className="text-white font-mono">{currentPage}</span> 页</span></div>
                                <div className="flex gap-2 flex-wrap justify-end">
                                    <button onClick={startBatchDownload} className="flex gap-2 px-3 py-2 bg-emerald-600/80 hover:bg-emerald-600 rounded-lg text-sm border border-emerald-500/50 shadow-lg"><Layers className="w-4 h-4" /> 浏览器下载</button>
                                    <button onClick={() => exportScript('windows')} className="flex gap-2 px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm"><Terminal className="w-4 h-4 text-yellow-400" /> Win脚本</button>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {results.map((item) => {
                                const isSelected = selectedIds.has(item.id);
                                const downloadInfo = getDownloadInfo(item);
                                const previewSrc = getPreviewSource(item);
                                let badgeColor = "bg-slate-700 text-slate-300";
                                if (downloadInfo?.label.includes("4K")) badgeColor = "bg-amber-500/20 text-amber-300 border border-amber-500/50";
                                
                                return (
                                    <div key={item.id} onClick={() => toggleSelect(item.id)} className={`group relative bg-slate-800 rounded-xl overflow-hidden border transition-all cursor-pointer ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-500/50' : 'border-slate-700 hover:border-slate-500'}`}>
                                        <div className="absolute top-3 left-3 z-20"><div className={`w-6 h-6 rounded border flex items-center justify-center shadow-lg ${isSelected ? 'bg-indigo-500 border-indigo-500' : 'bg-black/40 border-white/60'}`}>{isSelected && <Check className="w-4 h-4 text-white" />}</div></div>
                                        {mediaType === 'video' && <div className="absolute top-3 right-3 z-10 bg-black/60 px-2 py-1 rounded text-xs text-white">{item.duration}s</div>}
                                        <div className={`absolute bottom-3 right-3 z-10 px-2 py-1 rounded text-xs font-bold shadow-sm ${badgeColor}`}>{downloadInfo?.label}</div>
                                        <div className="relative aspect-video bg-black/50 group-hover:brightness-110">
                                            {mediaType === 'video' ? <video controls preload="none" poster={item.image} src={previewSrc} className="w-full h-full object-cover" onClick={(e) => e.stopPropagation()} /> : <img src={previewSrc} className="w-full h-full object-cover" />}
                                        </div>
                                        <div className="p-4 flex flex-col gap-2">
                                            <div className="flex justify-between"><span className="text-xs text-slate-400">ID: {item.id}</span><span className="text-xs font-mono text-slate-500">{downloadInfo?.width}x{downloadInfo?.height}</span></div>
                                            <div className="flex gap-2"><a href={downloadInfo?.link} target="_blank" className="flex-1 flex justify-center gap-2 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm" onClick={(e) => e.stopPropagation()}><Download className="w-4 h-4" /> 下载</a></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {downloadQueue.isOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
                                <div className="bg-slate-800 border border-slate-600 w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                                    <div className="p-4 border-b border-slate-700 flex justify-between bg-slate-900/50"><h3 className="font-bold flex gap-2">{downloadQueue.processing ? <Loader2 className="animate-spin text-emerald-500"/> : <Check className="text-emerald-500"/>} 下载队列</h3><button onClick={() => setDownloadQueue(prev => ({...prev, isOpen: false, processing: false }))}><X className="w-5 h-5"/></button></div>
                                    <div className="overflow-y-auto p-4 space-y-3 flex-1">
                                        {downloadQueue.items.map((item, idx) => (
                                            <div key={idx} className="flex justify-between bg-slate-900/50 p-3 rounded border border-slate-700/50 text-sm">
                                                <div className="flex flex-col mr-4"><span className="text-slate-200 truncate">{item.name}.{item.ext}</span><span className={`text-xs ${item.status==='success'?'text-emerald-400':item.status==='error'?'text-red-400':'text-amber-400'}`}>{item.status}</span></div>
                                                {item.status==='error' && <a href={item.link} target="_blank" className="text-xs bg-slate-700 px-2 py-1 rounded">直接打开</a>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>